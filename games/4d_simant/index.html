<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D SimAnt Professional — QuadCraft</title>
    <link rel="stylesheet" href="../4d_generic/hud-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0800;
            --panel: #141008;
            --border: #2a2010;
            --accent: #ffaa44;
            --red: #ff4444;
        }

        body {
            background: var(--bg);
            color: #e0d0b0;
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 12px 20px;
            background: #0c0c04;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 {
            font-size: 20px;
            color: var(--accent);
            margin: 0;
        }

        .game-canvas {
            flex: 1;
            position: relative;
            width: 100%;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 20px;
            pointer-events: none;
        }

        .panel {
            background: rgba(20, 16, 8, 0.9);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            min-width: 180px;
            pointer-events: auto;
        }

        .panel h3 {
            margin: 0 0 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: #886;
            letter-spacing: 1px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .yellow {
            color: var(--accent);
        }

        .red {
            color: var(--red);
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        button {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        button:hover {
            background: var(--accent);
            color: #000;
        }

        button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.active {
            background: var(--accent);
            color: #000;
        }

        .key {
            font-family: monospace;
            opacity: 0.6;
            font-size: 11px;
            margin-left: 5px;
        }

        .combat-log {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: rgba(20, 16, 8, 0.9);
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 340px;
            font-size: 11px;
            pointer-events: auto;
        }

        .combat-log h3 {
            margin: 0 0 8px;
            font-size: 11px;
            text-transform: uppercase;
            color: #886;
            letter-spacing: 1px;
        }

        .combat-log .log-entry {
            margin-bottom: 3px;
            color: #cc9966;
            font-family: monospace;
            font-size: 10px;
        }

        .combat-log .log-entry:last-child {
            color: #ffcc88;
        }
    </style>
</head>

<body>
    <header>
        <h1>4D SimAnt</h1>
        <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:var(--accent);color:#000;font-weight:600">Quadray</span>
        <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:#664422;color:#fff;font-weight:600">Synergetics</span>
        <div style="font-size: 13px; color: #666">Standard Edition</div>
    </header>

    <div class="game-canvas">
        <canvas id="c"></canvas>

        <div class="overlay">
            <div class="panel">
                <h3>Yellow Colony (You)</h3>
                <div class="stat-row"><span>Food</span> <span id="yFood" class="yellow">0</span></div>
                <div class="stat-row"><span>Ants</span> <span id="yPop" class="yellow">0</span></div>
                <div class="stat-row" style="font-size:12px; margin-top:5px; opacity:0.7">Queens: <span
                        id="yQueen">1</span></div>
            </div>

            <div class="panel">
                <h3>Red Colony (AI)</h3>
                <div class="stat-row"><span>Food</span> <span id="rFood" class="red">0</span></div>
                <div class="stat-row"><span>Ants</span> <span id="rPop" class="red">0</span></div>
            </div>

            <div class="panel">
                <h3>Synergetics</h3>
                <div class="stat-row"><span>World TV</span> <span id="syTV" class="yellow">--</span></div>
                <div class="stat-row"><span>Tunnel Fill</span> <span id="syFill" class="yellow">--</span></div>
                <div class="stat-row"><span>Colony CoM</span> <span id="syCom" class="yellow">--</span></div>
                <div class="stat-row"><span>Ant Spread</span> <span id="sySpread" class="yellow">--</span></div>
                <div class="stat-row"><span>Forage Radius</span> <span id="syForage" class="yellow">--</span></div>
                <div style="margin-top:8px">
                    <button onclick="verifySynergetics()" style="font-size:11px;padding:5px 10px">Verify Math</button>
                    <div id="verifyResult" style="font-size:10px;margin-top:4px;color:#886"></div>
                </div>
            </div>
        </div>

        <div class="combat-log" id="combatLog">
            <h3>Combat Log</h3>
            <div id="combatEntries"><div class="log-entry">No combat yet...</div></div>
        </div>

        <div class="controls">
            <button onclick="buy('worker')">Hatch Worker (10 Food)</button>
            <button onclick="buy('soldier')">Hatch Soldier (50 Food)</button>
            <button id="pheroBtn" onclick="togglePheromones()">Toggle Pheromones</button>
            <button onclick="game.reset()">Reset Game</button>
        </div>
    </div>

    <div class="hud" id="hud" style="position:absolute;bottom:60px;left:50%;transform:translateX(-50%);font-family:'Outfit',monospace;font-size:0.85rem;color:#94a3b8;text-align:center;padding:10px 20px;background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.06);border-radius:8px;backdrop-filter:blur(10px);z-index:2;min-width:400px;pointer-events:none;"></div>

    <!-- Shared QuadCraft Modules (all 12) -->
    <script src="../4d_generic/quadray.js"></script>
    <script src="../4d_generic/camera.js"></script>
    <script src="../4d_generic/projection.js"></script>
    <script src="../4d_generic/zoom.js"></script>
    <script src="../4d_generic/synergetics.js"></script>
    <script src="../4d_generic/game_loop.js"></script>
    <script src="../4d_generic/input_controller.js"></script>
    <script src="../4d_generic/grid_utils.js"></script>
    <script src="../4d_generic/base_board.js"></script>
    <script src="../4d_generic/pathfinding.js"></script>
    <script src="../4d_generic/base_renderer.js"></script>
    <script src="../4d_generic/base_game.js"></script>
    <script src="../4d_generic/hud.js"></script>
    <script src="../4d_generic/score_manager.js"></script>

    <!-- Game-specific modules -->
    <script src="js/simant_combat.js"></script>
    <script src="js/simant_pheromone_viz.js"></script>
    <script src="js/simant_ai.js"></script>
    <script src="js/simant_board.js"></script>
    <script src="js/simant_renderer.js"></script>
    <script src="js/simant_game.js"></script>
    <script>
        const canvas = document.getElementById('c');
        const hudEl = document.getElementById('hud');
        let game;

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.onresize = resize;

        resize();
        initialize();

        function initialize() {
            game = new SimAntGame(canvas, hudEl);
            game.init();
            updateHUD();
        }

        function buy(type) {
            game.buyUnit(type);
            updateHUD();
        }

        function togglePheromones() {
            if (!game || !game.renderer || !game.renderer.pheromoneViz) return;
            const viz = game.renderer.pheromoneViz;
            viz.enabled = !viz.enabled;
            const btn = document.getElementById('pheroBtn');
            if (btn) {
                btn.classList.toggle('active', viz.enabled);
            }
        }

        function updateHUD() {
            if (!game) return;
            const b = game.board;
            document.getElementById('yFood').innerText = Math.floor(b.foodStored[0]);
            document.getElementById('rFood').innerText = Math.floor(b.foodStored[1]);

            const yAnts = b.ants.filter(a => a.faction === 0 && a.alive).length;
            const rAnts = b.ants.filter(a => a.faction === 1 && a.alive).length;

            document.getElementById('yPop').innerText = yAnts;
            document.getElementById('rPop').innerText = rAnts;

            document.getElementById('yQueen').innerText = b.queens[0] && b.queens[0].alive ? "Alive" : "DEAD";

            // Update combat log
            if (typeof CombatSystem !== 'undefined' && CombatSystem.log.length > 0) {
                const entries = document.getElementById('combatEntries');
                if (entries) {
                    entries.innerHTML = CombatSystem.log.map(msg =>
                        `<div class="log-entry">${msg}</div>`
                    ).join('');
                }
            }

            requestAnimationFrame(updateHUD);
        }

        function updateSynergetics() {
            if (!game || !game.board) { requestAnimationFrame(updateSynergetics); return; }
            const b = game.board;
            const yAnts = b.ants.filter(a => a.faction === 0 && a.alive);
            // World Tetravolume
            const totalCells = b.grid.length;
            const tunnelCells = b.grid.filter(c => c === 0).length;
            document.getElementById('syTV').textContent = (totalCells * SYNERGETICS.S3).toFixed(0);
            document.getElementById('syFill').textContent = ((tunnelCells / totalCells) * 100).toFixed(1) + '%';
            // Colony center of mass
            if (yAnts.length > 0) {
                let sx = 0, sy = 0, sz = 0, sw = 0;
                for (const a of yAnts) { sx += a.x; sy += a.y; sz += a.z; sw += a.w; }
                const n = yAnts.length;
                document.getElementById('syCom').textContent = `(${(sx/n).toFixed(1)},${(sy/n).toFixed(1)},${(sz/n).toFixed(1)},${(sw/n).toFixed(1)})`;
                // Ant spread
                if (yAnts.length >= 2) {
                    let totalDist = 0, count = 0;
                    const sample = yAnts.slice(0, 20);
                    for (let i = 0; i < sample.length; i++) {
                        for (let j = i + 1; j < sample.length; j++) {
                            const q1 = new Quadray(sample[i].x, sample[i].y, sample[i].z, sample[i].w);
                            const q2 = new Quadray(sample[j].x, sample[j].y, sample[j].z, sample[j].w);
                            totalDist += Quadray.distance(q1, q2); count++;
                        }
                    }
                    document.getElementById('sySpread').textContent = (totalDist / count).toFixed(2);
                }
                // Foraging radius
                const nest = b.nests[0];
                if (nest) {
                    let maxDist = 0;
                    const nq = new Quadray(nest.x, nest.y, nest.z, nest.w);
                    for (const a of yAnts) {
                        const aq = new Quadray(a.x, a.y, a.z, a.w);
                        maxDist = Math.max(maxDist, Quadray.distance(nq, aq));
                    }
                    document.getElementById('syForage').textContent = maxDist.toFixed(2) + ' TV';
                }
            }
            requestAnimationFrame(updateSynergetics);
        }
        updateSynergetics();

        function verifySynergetics() {
            const r = verifyGeometricIdentities();
            document.getElementById('verifyResult').innerHTML = r.checks.map(c => `${c.passed ? '✅' : '❌'} ${c.name}`).join('<br>');
            document.getElementById('verifyResult').style.color = r.allPassed ? '#44ff44' : '#ff4444';
        }
    </script>
</body>

</html>